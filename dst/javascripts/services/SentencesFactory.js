onceUpon.factory("SentencesFactory",["$http","$rootScope",function(e,n){var t={},a=new lamejs;return t.sentences=[],t.latestTimestamp=null,t.currentlyPlaying=null,t.saveSentence=function(e,n){e.exportWAV(function(n){e.clear();var s=new FileReader;s.onload=function(e){var n=a.WavHeader.readHeader(new DataView(e.target.result));samples=new Int16Array(e.target.result,n.dataOffset,n.dataLen/2),t.encodeMonoMP3(n.channels,n.sampleRate,samples)},s.readAsArrayBuffer(n)})},t.encodeMonoMP3=function(e,n,s){var r=[];mp3enc=new a.Mp3Encoder(e,n,192);for(var o=s.length,c=1152,l=0;o>=c;l+=c){var u=s.subarray(l,l+c),i=mp3enc.encodeBuffer(u);i.length>0&&r.push(new Int8Array(i)),o-=c}var f=mp3enc.flush();f.length>0&&r.push(new Int8Array(f));var m=new Blob(r,{type:"audio/mp3"});t.saveMP3ToDB(m)},t.saveMP3ToDB=function(n){var t=new FileReader;t.onload=function(n){e({method:"POST",url:"saveRecording",data:{audio:n.target.result,text:"test",timestamp:new Date}}).then(function(e){},function(e){console.log("Error saving MP3 file to db: "+e)})},t.readAsDataURL(n)},t.getAll=function(){return e.get("/sentences").success(function(e){t.sentences=e,t.latestTimestamp=t.sentences[t.sentences.length-1].timestamp})},t.getNew=function(){return t.latestTimestamp?e.get("/sentences/new/"+t.latestTimestamp).success(function(e){t.sentences=t.sentences.concat(e),t.latestTimestamp=(new Date).toISOString()}):t.getAll()},t}]);